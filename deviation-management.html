<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Deviation Management and CAPA System - Challenging Point Solution">
    <title>Deviation & CAPA Management | Pharmaceutical QMS</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">
                <span>üè•</span>
                <span>Pharma QMS</span>
            </a>

            <button class="menu-toggle" id="menuToggle">
                <span></span>
                <span></span>
                <span></span>
            </button>

            <ul class="nav-menu" id="navMenu">
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="processes.html" class="nav-link">QMS Processes</a></li>
                <li><a href="standards.html" class="nav-link">Standards</a></li>
                <li><a href="deviation-management.html" class="nav-link active">Deviation & CAPA</a></li>
                <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                <li><a href="monitoring.html" class="nav-link">Monitoring</a></li>
                <li><a href="reports.html" class="nav-link">Reports</a></li>
            </ul>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero" style="padding: 3rem 1.5rem;">
        <div class="hero-content">
            <h1>‚ö†Ô∏è Deviation & CAPA Management</h1>
            <p>Our solution to pharmaceutical QMS's most challenging process</p>
            <span class="badge"
                style="background: var(--white); color: var(--primary-blue); font-size: 1rem; padding: 0.5rem 1rem;">Featured
                Challenging Point</span>
        </div>
    </section>

    <!-- The Challenge -->
    <section class="container">
        <div class="card" style="background: linear-gradient(135deg, #388d9c 0%, #207edd 100%); color: var(--white);">
            <h2 style="color: var(--white);">üéØ The Challenge</h2>
            <p style="font-size: 1.1rem; opacity: 0.95;">Deviation management is one of the most complex and critical
                aspects of pharmaceutical quality management. Organizations face multiple challenges:</p>

            <div class="grid grid-2 mt-3">
                <div>
                    <h4 style="color: var(--white);">‚ùå Common Pain Points</h4>
                    <ul style="opacity: 0.9;">
                        <li><strong>Complex Tracking:</strong> Managing deviations across multiple departments and
                            production lines</li>
                        <li><strong>Investigation Delays:</strong> Slow root cause analysis leading to extended closure
                            times</li>
                        <li><strong>CAPA Effectiveness:</strong> Difficulty verifying that corrective actions actually
                            prevent recurrence</li>
                        <li><strong>Trend Analysis:</strong> Manual processes make it hard to identify patterns and
                            recurring issues</li>
                        <li><strong>Regulatory Compliance:</strong> Meeting strict timelines and documentation
                            requirements</li>
                        <li><strong>Resource Allocation:</strong> Prioritizing investigations based on risk and impact
                        </li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: var(--white);">üìä Impact on Operations</h4>
                    <ul style="opacity: 0.9;">
                        <li>Average 30-45 days to close deviations</li>
                        <li>40% of deviations are recurring issues</li>
                        <li>Significant time spent on manual documentation</li>
                        <li>Difficulty demonstrating CAPA effectiveness</li>
                        <li>Risk of regulatory findings during inspections</li>
                        <li>Lost productivity due to investigation overhead</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <!-- Our Solution -->
    <section class="section" style="background: var(--white);">
        <div class="container">
            <div class="section-title">
                <h2>‚úÖ Our Solution</h2>
                <p>An integrated, interactive deviation and CAPA management system</p>
            </div>

            <div class="grid grid-3">
                <div class="card">
                    <div class="card-icon" style="background: var(--gradient-success);">üîç</div>
                    <h4>Automated Workflows</h4>
                    <p>Streamlined deviation submission, routing, and approval processes with automated notifications
                        and escalations</p>
                </div>
                <div class="card">
                    <div class="card-icon" style="background: var(--gradient-success);">üìà</div>
                    <h4>Risk-Based Prioritization</h4>
                    <p>Automated risk assessment calculator to prioritize investigations based on severity, occurrence,
                        and detection</p>
                </div>
                <div class="card">
                    <div class="card-icon" style="background: var(--gradient-success);">üõ†Ô∏è</div>
                    <h4>Root Cause Analysis Tools</h4>
                    <p>Integrated 5 Whys, Fishbone diagrams, and guided investigation templates</p>
                </div>
                <div class="card">
                    <div class="card-icon" style="background: var(--gradient-success);">üìä</div>
                    <h4>Real-Time Analytics</h4>
                    <p>Interactive dashboards showing trends, patterns, and performance metrics</p>
                </div>
                <div class="card">
                    <div class="card-icon" style="background: var(--gradient-success);">‚úì</div>
                    <h4>CAPA Tracking</h4>
                    <p>Comprehensive CAPA management with effectiveness verification and closure tracking</p>
                </div>
                <div class="card">
                    <div class="card-icon" style="background: var(--gradient-success);">üì±</div>
                    <h4>Mobile Access</h4>
                    <p>Submit and review deviations from any device, anywhere</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Interactive Deviation Submission -->
    <section class="container">
        <div class="section-title">
            <h2>Submit a Deviation</h2>
            <p>Try our interactive deviation submission form</p>
        </div>

        <div class="card">
            <form id="deviationForm">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Deviation Title *</label>
                        <input type="text" class="form-input" id="devTitle" required
                            placeholder="Brief description of the deviation">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Department *</label>
                        <select class="form-select" id="devDepartment" required>
                            <option value="">Select Department</option>
                            <option value="Production">Production</option>
                            <option value="Quality Control">Quality Control</option>
                            <option value="Quality Assurance">Quality Assurance</option>
                            <option value="Warehouse">Warehouse</option>
                            <option value="Engineering">Engineering</option>
                            <option value="R&D">R&D</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Deviation Category *</label>
                        <select class="form-select" id="devCategory" required>
                            <option value="">Select Category</option>
                            <option value="Documentation">Documentation</option>
                            <option value="Equipment">Equipment</option>
                            <option value="Material">Material</option>
                            <option value="Process">Process</option>
                            <option value="Personnel">Personnel</option>
                            <option value="Environmental">Environmental</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Batch Number</label>
                        <input type="text" class="form-input" id="devBatch" placeholder="e.g., BT-2024-001">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Deviation Description *</label>
                    <textarea class="form-textarea" id="devDescription" required
                        placeholder="Detailed description of what happened, when, and where"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Immediate Action Taken</label>
                    <textarea class="form-textarea" id="devAction"
                        placeholder="Describe any immediate corrective actions taken"></textarea>
                </div>

                <h4 class="mt-3 mb-2">Risk Assessment</h4>
                <div class="grid grid-3">
                    <div class="form-group">
                        <label class="form-label">Severity (1-10) *</label>
                        <input type="number" class="form-input" id="riskSeverity" min="1" max="10" required>
                        <small style="color: var(--gray-600);">Impact on product quality/safety</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Occurrence (1-10) *</label>
                        <input type="number" class="form-input" id="riskOccurrence" min="1" max="10" required>
                        <small style="color: var(--gray-600);">Likelihood of happening again</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Detection (1-10) *</label>
                        <input type="number" class="form-input" id="riskDetection" min="1" max="10" required>
                        <small style="color: var(--gray-600);">Difficulty in detecting the issue</small>
                    </div>
                </div>

                <div id="riskResult" class="mt-3" style="display: none;"></div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">Submit Deviation</button>
                    <button type="reset" class="btn btn-outline">Clear Form</button>
                </div>
            </form>
        </div>
    </section>

    <!-- Root Cause Analysis Tools -->
    <section class="section" style="background: var(--gray-50);">
        <div class="container">
            <div class="section-title">
                <h2>Root Cause Analysis Tools</h2>
                <p>Integrated tools for effective investigation</p>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <h3>5 Whys Analysis</h3>
                    <p>Iterative questioning technique to explore cause-and-effect relationships</p>

                    <div class="mt-3">
                        <div class="form-group">
                            <label class="form-label">Problem Statement:</label>
                            <input type="text" class="form-input" id="why0" placeholder="What is the problem?">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Why 1:</label>
                            <input type="text" class="form-input" id="why1" placeholder="Why did this happen?">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Why 2:</label>
                            <input type="text" class="form-input" id="why2" placeholder="Why did that happen?">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Why 3:</label>
                            <input type="text" class="form-input" id="why3" placeholder="Why did that happen?">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Why 4:</label>
                            <input type="text" class="form-input" id="why4" placeholder="Why did that happen?">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Why 5 (Root Cause):</label>
                            <input type="text" class="form-input" id="why5" placeholder="Root cause identified">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Fishbone Diagram</h3>
                    <p>Visual tool to categorize potential causes of problems</p>

                    <div class="mermaid">
                        graph LR
                        A[People] --> E[Deviation]
                        B[Process] --> E
                        C[Equipment] --> E
                        D[Materials] --> E
                        F[Environment] --> E
                        G[Measurement] --> E
                    </div>

                    <div class="mt-3">
                        <h5>Common Cause Categories:</h5>
                        <ul>
                            <li><strong>People:</strong> Training, competency, fatigue</li>
                            <li><strong>Process:</strong> Procedures, controls, complexity</li>
                            <li><strong>Equipment:</strong> Calibration, maintenance, design</li>
                            <li><strong>Materials:</strong> Quality, storage, handling</li>
                            <li><strong>Environment:</strong> Temperature, humidity, cleanliness</li>
                            <li><strong>Measurement:</strong> Methods, accuracy, precision</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- CAPA Management -->
    <section class="container">
        <div class="section-title">
            <h2>CAPA Management</h2>
            <p>Corrective and Preventive Action tracking and effectiveness verification</p>
        </div>

        <div class="card">
            <h3>CAPA Workflow</h3>
            <div class="mermaid">
                graph TB
                A[Deviation Identified] --> B[Root Cause Analysis]
                B --> C{Corrective Action Needed?}
                C -->|Yes| D[Define Corrective Action]
                C -->|No| E[Close Deviation]
                D --> F[Implement Corrective Action]
                F --> G[Verify Effectiveness]
                G --> H{Effective?}
                H -->|Yes| I[Preventive Action Assessment]
                H -->|No| B
                I --> J{Preventive Action Needed?}
                J -->|Yes| K[Implement Preventive Action]
                J -->|No| E
                K --> L[Monitor for Recurrence]
                L --> E
                </graph>
            </div>
        </div>

        <div class="card mt-4">
            <h3>Active CAPA Tracking</h3>
            <div class="table-container">
                <table id="capaTable">
                    <thead>
                        <tr>
                            <th>CAPA ID</th>
                            <th>Related Deviation</th>
                            <th>Action Type</th>
                            <th>Owner</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th>Progress</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>CAPA-2024-015</strong></td>
                            <td>DEV-2024-089</td>
                            <td>Corrective</td>
                            <td>J. Smith</td>
                            <td>Dec 20, 2024</td>
                            <td><span class="badge badge-warning">In Progress</span></td>
                            <td>75%</td>
                        </tr>
                        <tr>
                            <td><strong>CAPA-2024-014</strong></td>
                            <td>DEV-2024-087</td>
                            <td>Preventive</td>
                            <td>M. Johnson</td>
                            <td>Dec 18, 2024</td>
                            <td><span class="badge badge-info">Verification</span></td>
                            <td>90%</td>
                        </tr>
                        <tr>
                            <td><strong>CAPA-2024-013</strong></td>
                            <td>DEV-2024-085</td>
                            <td>Corrective</td>
                            <td>R. Williams</td>
                            <td>Dec 15, 2024</td>
                            <td><span class="badge badge-success">Closed</span></td>
                            <td>100%</td>
                        </tr>
                        <tr>
                            <td><strong>CAPA-2024-012</strong></td>
                            <td>DEV-2024-082</td>
                            <td>Preventive</td>
                            <td>K. Brown</td>
                            <td>Dec 22, 2024</td>
                            <td><span class="badge badge-warning">In Progress</span></td>
                            <td>60%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Analytics & Trends -->
    <section class="section" style="background: var(--white);">
        <div class="container">
            <div class="section-title">
                <h2>Analytics & Trend Analysis</h2>
                <p>Data-driven insights for continuous improvement</p>
            </div>

            <!-- Chart Controls -->
            <div class="card" style="margin-bottom: 2rem;">
                <div class="grid grid-3">
                    <div class="form-group">
                        <label class="form-label">Filter by Status</label>
                        <select class="form-select" id="chartFilterStatus">
                            <option value="">All Statuses</option>
                            <option value="Open">Open</option>
                            <option value="Under Investigation">Under Investigation</option>
                            <option value="CAPA Required">CAPA Required</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Filter by Category</label>
                        <select class="form-select" id="chartFilterCategory">
                            <option value="">All Categories</option>
                            <option value="Documentation">Documentation</option>
                            <option value="Equipment">Equipment</option>
                            <option value="Material">Material</option>
                            <option value="Process">Process</option>
                            <option value="Personnel">Personnel</option>
                            <option value="Environmental">Environmental</option>
                        </select>
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-primary" id="refreshChartsBtn" style="width: 100%;">
                            üîÑ Refresh Charts
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div class="chart-container" style="min-height: 450px; padding: 2rem;">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title" style="font-size: 1.5rem;">Deviation Trends (Last 6 Months)</h3>
                            <small style="color: var(--gray-600);">Click on data points for details</small>
                        </div>
                    </div>
                    <canvas id="deviationTrendChart" style="max-height: 350px;"></canvas>
                </div>

                <div class="chart-container" style="min-height: 450px; padding: 2rem;">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title" style="font-size: 1.5rem;">Deviation by Category</h3>
                            <small style="color: var(--gray-600);">Click on bars for category details</small>
                        </div>
                    </div>
                    <canvas id="categoryChart" style="max-height: 350px;"></canvas>
                </div>

                <div class="chart-container" style="min-height: 450px; padding: 2rem;">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title" style="font-size: 1.5rem;">CAPA Closure Performance</h3>
                            <small style="color: var(--gray-600);">Monthly on-time closure rate</small>
                        </div>
                    </div>
                    <canvas id="capaPerformanceChart" style="max-height: 350px;"></canvas>
                </div>

                <div class="chart-container" style="min-height: 450px; padding: 2rem;">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title" style="font-size: 1.5rem;">Risk Distribution</h3>
                            <small style="color: var(--gray-600);">Click on segments for details</small>
                        </div>
                    </div>
                    <canvas id="riskDistributionChart" style="max-height: 350px;"></canvas>
                </div>
            </div>

            <!-- Chart Statistics Summary -->
            <div class="card" style="margin-top: 2rem;" id="chartStatsSummary">
                <h4>Current Statistics</h4>
                <div class="grid grid-4" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalDeviations">-</div>
                        <div class="stat-label">Total Deviations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="openDeviations">-</div>
                        <div class="stat-label">Open Deviations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalCapa">-</div>
                        <div class="stat-label">Total CAPA</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgClosureRate">-</div>
                        <div class="stat-label">Avg. On-Time Closure</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Results -->
    <section class="container">
        <div class="card" style="background: var(--gradient-success); color: var(--white);">
            <h2 style="color: var(--white);">üéâ Results Achieved</h2>
            <p style="font-size: 1.1rem; opacity: 0.95;">Our integrated deviation and CAPA management system has
                delivered measurable improvements:</p>

            <div class="stats-grid mt-4">
                <div class="stat-card" style="border-left-color: var(--white);">
                    <div class="stat-value" style="color: var(--success);">95%</div>
                    <div class="stat-label">On-Time CAPA Closure</div>
                    <div class="stat-trend trend-up">‚Üë 25% improvement</div>
                </div>
                <div class="stat-card" style="border-left-color: var(--white);">
                    <div class="stat-value" style="color: var(--success);">40%</div>
                    <div class="stat-label">Reduction in Recurring Deviations</div>
                    <div class="stat-trend trend-up">Year over year</div>
                </div>
                <div class="stat-card" style="border-left-color: var(--white);">
                    <div class="stat-value" style="color: var(--success);">15 Days</div>
                    <div class="stat-label">Average Time to Close</div>
                    <div class="stat-trend trend-up">‚Üì 50% reduction</div>
                </div>
                <div class="stat-card" style="border-left-color: var(--white);">
                    <div class="stat-value" style="color: var(--success);">100%</div>
                    <div class="stat-label">Investigation Compliance</div>
                    <div class="stat-trend trend-up">Regulatory ready</div>
                </div>
            </div>

            <div class="mt-4">
                <h4 style="color: var(--white);">Key Success Factors:</h4>
                <ul style="opacity: 0.95; font-size: 1.05rem;">
                    <li>‚úì Automated workflows reduce manual effort by 60%</li>
                    <li>‚úì Risk-based prioritization ensures critical issues are addressed first</li>
                    <li>‚úì Integrated RCA tools improve investigation quality</li>
                    <li>‚úì Real-time analytics enable proactive trend identification</li>
                    <li>‚úì Mobile access increases submission and review efficiency</li>
                    <li>‚úì Effectiveness verification prevents recurrence</li>
                </ul>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>Pharmaceutical QMS</h3>
                <p>Comprehensive Quality Management System for pharmaceutical production excellence.</p>
            </div>

            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul class="footer-links">
                    <li><a href="processes.html">QMS Processes</a></li>
                    <li><a href="standards.html">Standards</a></li>
                    <li><a href="dashboard.html">Dashboard</a></li>
                    <li><a href="reports.html">Reports</a></li>
                </ul>
            </div>

            <div class="footer-section">
                <h3>Resources</h3>
                <ul class="footer-links">
                    <li><a href="deviation-management.html">Deviation Management</a></li>
                    <li><a href="monitoring.html">Environmental Monitoring</a></li>
                    <li><a href="#">Documentation</a></li>
                    <li><a href="#">Training Materials</a></li>
                </ul>
            </div>

            <div class="footer-section">
                <h3>Compliance</h3>
                <ul class="footer-links">
                    <li><a href="standards.html#gmp">GMP Compliance</a></li>
                    <li><a href="standards.html#fda">FDA Regulations</a></li>
                    <li><a href="standards.html#iso">ISO Standards</a></li>
                    <li><a href="standards.html#ich">ICH Guidelines</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p>&copy; 2025 Pharmaceutical QMS. Quality Management System for Educational Purposes.</p>
        </div>
    </footer>

    <script src="script.js"></script>
    <script src="api-client.js"></script>
    <script>
        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });

        // Risk Assessment Calculator
        document.getElementById('riskSeverity').addEventListener('input', calculateRisk);
        document.getElementById('riskOccurrence').addEventListener('input', calculateRisk);
        document.getElementById('riskDetection').addEventListener('input', calculateRisk);

        function calculateRisk() {
            const severity = parseInt(document.getElementById('riskSeverity').value) || 0;
            const occurrence = parseInt(document.getElementById('riskOccurrence').value) || 0;
            const detection = parseInt(document.getElementById('riskDetection').value) || 0;

            if (severity && occurrence && detection) {
                const rpn = calculateRiskScore(severity, occurrence, detection);
                const risk = getRiskLevel(rpn);

                const resultDiv = document.getElementById('riskResult');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <div class="alert" style="background: ${risk.color}20; border-color: ${risk.color}; color: ${risk.color};">
                        <strong>Risk Priority Number (RPN): ${rpn}</strong><br>
                        Risk Level: ${risk.level}<br>
                        Priority: ${risk.priority}
                    </div>
                `;
            }
        }

        // Form Submission - Save to Database via API
        document.getElementById('deviationForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            if (validateForm('deviationForm')) {
                const severity = parseInt(document.getElementById('riskSeverity').value);
                const occurrence = parseInt(document.getElementById('riskOccurrence').value);
                const detection = parseInt(document.getElementById('riskDetection').value);

                // Generate unique deviation number
                const timestamp = Date.now();
                const deviationNumber = 'DEV-2024-' + String(timestamp).slice(-4);

                const formData = {
                    deviation_number: deviationNumber,
                    title: document.getElementById('devTitle').value,
                    description: document.getElementById('devDescription').value,
                    category: document.getElementById('devCategory').value,
                    severity: severity,
                    occurrence: occurrence,
                    detection: detection,
                    department: document.getElementById('devDepartment').value,
                    product_batch: document.getElementById('devBatch').value || null,
                    detected_date: new Date().toISOString().split('T')[0],
                    created_by: 1  // Default user ID
                };

                try {
                    // Save to database via API
                    const result = await DeviationAPI.create(formData);

                    showNotification(`Deviation submitted successfully! ID: ${deviationNumber}`, 'success');
                    this.reset();
                    document.getElementById('riskResult').style.display = 'none';

                    console.log('Deviation saved to database:', result);
                } catch (error) {
                    console.error('Error saving deviation:', error);
                    showNotification('Error submitting deviation. Please ensure API server is running.', 'error');
                }
            }
        });

        // Helper function to transform API data for charts
        function transformObjectToArrays(dataObject) {
            if (!dataObject || Object.keys(dataObject).length === 0) {
                return { labels: [], data: [] };
            }
            return {
                labels: Object.keys(dataObject),
                data: Object.values(dataObject)
            };
        }

        // Helper function to show chart error
        function showChartError(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (canvas) {
                const parent = canvas.parentElement;
                parent.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--gray-600);">
                        <p>‚ö†Ô∏è Unable to load chart data</p>
                        <small>Please ensure the API server is running</small>
                    </div>
                `;
            }
        }

        // Helper function to safely destroy existing chart
        function destroyChart(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (canvas) {
                const existingChart = Chart.getChart(canvas);
                if (existingChart) {
                    existingChart.destroy();
                }
            }
        }

        // Initialize Charts with Database Data
        document.addEventListener('DOMContentLoaded', async function () {
            // Initial chart load
            await loadAllCharts();

            // Set up filter event listeners
            document.getElementById('chartFilterStatus').addEventListener('change', loadAllCharts);
            document.getElementById('chartFilterCategory').addEventListener('change', loadAllCharts);
            document.getElementById('refreshChartsBtn').addEventListener('click', loadAllCharts);
        });

        // Global chart instances
        let chartInstances = {
            trend: null,
            category: null,
            capa: null,
            risk: null
        };

        // Load all charts with current filters
        async function loadAllCharts() {
            try {
                // Show loading state
                if (typeof showNotification === 'function') {
                    showNotification('Loading chart data...', 'info');
                }

                // Get filter values
                const statusFilter = document.getElementById('chartFilterStatus')?.value || '';
                const categoryFilter = document.getElementById('chartFilterCategory')?.value || '';

                // Fetch data from API with filters
                const filters = {};
                if (statusFilter) filters.status = statusFilter;
                if (categoryFilter) filters.category = categoryFilter;

                const [stats, trends, capaStats, allDeviations] = await Promise.all([
                    DeviationAPI.getStats(),
                    DashboardAPI.getTrends(),
                    CAPAAPI.getStats(),
                    DeviationAPI.getAll(filters)
                ]);

                console.log('API Data Received:', { stats, trends, capaStats, allDeviations });

                // Update statistics summary
                updateStatsSummary(stats, capaStats);

                // Initialize/update all charts
                await initDeviationTrendChart(trends);
                await initCategoryChart(stats);
                await initCapaPerformanceChart(capaStats);
                await initRiskDistributionChart(stats);

                console.log('‚úì All charts loaded successfully');

                if (typeof showNotification === 'function') {
                    showNotification('Charts updated successfully', 'success');
                }

            } catch (error) {
                console.error('Error loading chart data:', error);
                if (typeof showNotification === 'function') {
                    showNotification('Unable to load chart data. Please ensure the API server is running.', 'error');
                }
            }
        }

        // Update statistics summary
        function updateStatsSummary(deviationStats, capaStats) {
            // Total deviations
            document.getElementById('totalDeviations').textContent = deviationStats.total || 0;

            // Open deviations
            const openCount = deviationStats.by_status?.['Open'] || 0;
            document.getElementById('openDeviations').textContent = openCount;

            // Total CAPA
            document.getElementById('totalCapa').textContent = capaStats.total || 0;

            // Average on-time closure rate
            if (capaStats.closure_trend && capaStats.closure_trend.length > 0) {
                const avgRate = capaStats.closure_trend.reduce((sum, item) => sum + item.percentage, 0) / capaStats.closure_trend.length;
                document.getElementById('avgClosureRate').textContent = Math.round(avgRate) + '%';
            } else {
                document.getElementById('avgClosureRate').textContent = 'N/A';
            }
        }

        // Initialize Deviation Trend Chart
        async function initDeviationTrendChart(trends) {
            destroyChart('deviationTrendChart');
            const trendCtx = document.getElementById('deviationTrendChart');

            if (!trendCtx) return;

            let trendLabels = [];
            let trendData = [];

            if (trends.deviation_trend && trends.deviation_trend.length > 0) {
                trendLabels = trends.deviation_trend.map(item => {
                    const date = new Date(item.month + '-01');
                    return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                });
                trendData = trends.deviation_trend.map(item => Number(item.count));
            } else {
                trendLabels = ['No Data'];
                trendData = [0];
            }

            chartInstances.trend = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: [{
                        label: 'Total Deviations',
                        data: trendData,
                        borderColor: chartColors.primary,
                        backgroundColor: 'rgba(0, 102, 204, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: chartColors.primary,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    ...chartDefaults,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const month = trends.deviation_trend[index].month;
                            const count = trends.deviation_trend[index].count;
                            if (typeof showNotification === 'function') {
                                showNotification(`${month}: ${count} deviations`, 'info');
                            }
                        }
                    }
                }
            });
        }

        // Initialize Category Chart
        async function initCategoryChart(stats) {
            destroyChart('categoryChart');
            const categoryCtx = document.getElementById('categoryChart');

            if (!categoryCtx) return;

            const categoryData = transformObjectToArrays(stats.by_category);
            const counts = categoryData.data.map(d => Number(d));

            // Define colors for each category
            const categoryColors = {
                'Documentation': chartColors.primary,
                'Equipment': chartColors.secondary,
                'Material': chartColors.success,
                'Process': chartColors.warning,
                'Personnel': chartColors.purple,
                'Environmental': chartColors.gray
            };

            const colors = categoryData.labels.map(label =>
                categoryColors[label] || chartColors.primary
            );

            const labels = categoryData.labels.length > 0 ? categoryData.labels : ['No Data'];
            const data = counts.length > 0 ? counts : [0];

            chartInstances.category = new Chart(categoryCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Deviations',
                        data: data,
                        backgroundColor: colors.length > 0 ? colors : [chartColors.gray],
                        borderRadius: 8,
                        borderWidth: 0
                    }]
                },
                options: {
                    ...chartDefaults,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    onClick: async (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const category = labels[index];
                            const count = data[index];
                            if (typeof showNotification === 'function') {
                                showNotification(`${category}: ${count} deviations. Click to view details.`, 'info');
                            }
                            // You could navigate to a filtered view here
                            console.log(`Category clicked: ${category}`);
                        }
                    }
                }
            });
        }

        // Initialize CAPA Performance Chart
        async function initCapaPerformanceChart(capaStats) {
            destroyChart('capaPerformanceChart');
            const capaCtx = document.getElementById('capaPerformanceChart');

            if (!capaCtx) return;

            let capaLabels = [];
            let capaData = [];

            if (capaStats.closure_trend && capaStats.closure_trend.length > 0) {
                capaLabels = capaStats.closure_trend.map(item => {
                    const date = new Date(item.month + '-01');
                    return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                });
                capaData = capaStats.closure_trend.map(item => Number(item.percentage));
            } else {
                // Fallback to static data if no database data available
                capaLabels = ['Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                capaData = [70, 75, 82, 88, 92, 95];
            }

            chartInstances.capa = new Chart(capaCtx, {
                type: 'line',
                data: {
                    labels: capaLabels,
                    datasets: [{
                        label: 'On-Time Closure %',
                        data: capaData,
                        borderColor: chartColors.success,
                        backgroundColor: 'rgba(0, 200, 83, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: chartColors.success,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    ...chartDefaults,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function (value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0 && capaStats.closure_trend) {
                            const index = elements[0].index;
                            const item = capaStats.closure_trend[index];
                            if (typeof showNotification === 'function') {
                                showNotification(`${item.month}: ${item.on_time}/${item.total} CAPA closed on-time (${item.percentage}%)`, 'info');
                            }
                        }
                    }
                }
            });
        }

        // Initialize Risk Distribution Chart
        async function initRiskDistributionChart(stats) {
            destroyChart('riskDistributionChart');
            const riskCtx = document.getElementById('riskDistributionChart');

            if (!riskCtx) return;

            const riskData = transformObjectToArrays(stats.by_risk);
            const counts = riskData.data.map(d => Number(d));

            // Define colors for risk levels
            const riskColors = {
                'Low': chartColors.success,
                'Medium': chartColors.warning,
                'High': '#ff9100',
                'Critical': chartColors.danger
            };

            const colors = riskData.labels.map(label =>
                riskColors[label] || chartColors.gray
            );

            const labels = riskData.labels.length > 0 ? riskData.labels : ['No Data'];
            const data = counts.length > 0 ? counts : [1];

            chartInstances.risk = new Chart(riskCtx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.length > 0 ? colors : [chartColors.gray],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    ...chartDefaults,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const riskLevel = labels[index];
                            const count = data[index];
                            if (typeof showNotification === 'function') {
                                showNotification(`${riskLevel} Risk: ${count} deviations`, 'info');
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>